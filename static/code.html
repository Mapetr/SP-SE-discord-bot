<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auth</title>
    <style>
        body {
            background: black;
        }
    </style>
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js" type="text/javascript"></script>
    <script type="text/javascript">
	    const msalConfig = {
		    auth: {
			    clientId: "937b0815-bf58-44cd-a0aa-7b81e34023c4",
			    authority: "https://login.microsoftonline.com/e7bf04a2-63c8-4a47-a0bd-28d0aa88f6ec/",
			    redirectUri: "https://spsse.ayai.dev/auth"
		    },
		    cache: {
			    cacheLocation: "sessionStorage",
			    storeAuthStateInCookie: false
		    }
	    }
	    const msalInstance = new msal.PublicClientApplication(msalConfig);
        let l = "";
	    msalInstance.loginPopup()
		    .then((response) => {
			    if (response) {
                    l = response.account.name;
				    f(response);
			    }
		    }).catch((error) => {
                console.log(error);
	        });
    </script>
    <script type="text/javascript">
        function f() {
          const account = msalInstance.getAllAccounts()[0];
          const req = {
            scopes: ["User.Read"],
            account: account
          };
          msalInstance.acquireTokenSilent(req)
            .then((res) => {
              r(res.accessToken);
            })
            .catch((err) => {
	            if (err instanceof InteractionRequiredAuthError) {
                msalInstance.acquireTokenPopup(req)
                    .then((res) => {
                        r(res.accessToken);
                    })
                    .catch((err) => {
                        console.log(err);
                    });
                }
            });
        }
        function r(tok) {
	        fetch(`https://graph.microsoft.com/beta/me/profile/positions`, {
		        method: 'GET',
		        headers: {
			        "Authorization": `Bearer ${tok}`
		        }}).then((response) => {
		        return response.json();
	        }).then(async (data) => {
		        const c = a(data.value[0].detail.company.department);
		        await fetch(`https://spsse.ayai.dev/auth/resp/${location.pathname.split('/')[2]}`, {
			        method: 'PUT',
			        headers: {
				        "Content-Type": "application/json"
			        },
			        body: JSON.stringify({
				        "name": l,
				        "department": c,
			        })
		        });
	        }).catch((error) => {
		        console.log(error);
	        });
        }
    </script>
    <script type="text/javascript">
        function a(txt) {
          txt = txt.replace(/[a-z()]/g, '');
          txt = Array.from(txt);
          let result = "";
          result += txt.shift();
          const e = txt.pop();
          txt.shift();
          txt.filter(x => x.includes());
          let sp = txt.toString().replaceAll(',','').split('-');
          const date = new Date();
          const b = Math.abs(Number(sp[0])-date.getFullYear());
          const g = date.getMonth() > 8 ? b+1 : b
          if (g > 4) {
            result = 'ABS';
          } else {
            result += g+e;
          }
          return result;
        }
    </script>
</head>
<body>
</body>
</html>
